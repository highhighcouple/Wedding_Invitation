<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Great+Vibes&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <!-- Tailwind & Alpine -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Map SDK -->
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=dacffa882aa3284870d06afa02bd5947&libraries=services"></script>

    <style>
        :root {
            --accent: #f2aebc;
            --text: #333;
            --bg: #fff;
        }

        body {
            font-family: 'Gowun Batang', serif;
            color: var(--text);
            overflow-x: hidden;
        }

        .eng-font {
            font-family: 'Great Vibes', cursive;
        }

        .lux-font {
            font-family: 'Nanum Myeongjo', serif;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Effect Canvas */
        #effect-canvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 50;
        }

        /* Animations */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: 1s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }

        .section-content.open {
            max-height: 2000px;
            transition: max-height 0.8s ease-in;
        }

        /* Calendar */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }

        .cal-cell {
            padding: 8px;
            font-size: 0.9rem;
        }

        .cal-sat {
            color: #3b82f6;
        }

        .cal-sun {
            color: #ef4444;
        }

        .cal-wedding {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body x-data="app()" x-init="init()" class="relative">

    <!-- Language & BGM Controls -->
    <div class="fixed top-4 right-4 z-[60] flex gap-2">
        <select x-model="lang" @change="changeLang()"
            class="bg-white/80 backdrop-blur border rounded-full px-3 py-1 text-xs shadow-md outline-none">
            <option value="ko">üá∞üá∑ KOR</option>
            <option value="en">üá∫üá∏ ENG</option>
            <option value="jp">üáØüáµ JPN</option>
            <option value="cn">üá®üá≥ CHN</option>
        </select>
        <button @click="toggleBgm"
            class="w-8 h-8 rounded-full bg-white/80 backdrop-blur shadow-md flex items-center justify-center text-xs animate-pulse">
            <span x-text="bgmPlaying ? 'üîä' : 'üîá'"></span>
        </button>
    </div>

    <!-- Canvas Effect -->
    <canvas id="effect-canvas"></canvas>

    <!-- Main Rendering Loop -->
    <template x-for="section in sortedSections" :key="section.id">
        <section :id="section.id"
            class="relative max-w-lg mx-auto bg-white min-h-[100px] border-b border-gray-50 last:border-0 reveal">

            <!-- Header (Toggle) -->
            <div @click="toggleFold(section)" class="p-8 cursor-pointer group hover:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl lux-font font-bold text-gray-800" x-text="t(section.id)"></h2>
                    <span class="text-gray-400 group-hover:text-pink-400 transition"
                        x-text="section.isFolded ? '+' : '-'"></span>
                </div>
            </div>

            <!-- Content -->
            <div class="section-content" :class="!section.isFolded ? 'open' : ''">
                <div class="px-8 pb-12">

                    <!-- 1. Names -->
                    <template x-if="section.id === 'names'">
                        <div class="text-center space-y-8">
                            <div class="text-3xl eng-font text-pink-400" x-text="data.text.mainOverlay"></div>
                            <div class="whitespace-pre-line text-sm leading-8 text-gray-600"
                                x-text="data.text.mainMessage"></div>

                            <div class="flex justify-center items-center gap-8 py-8 border-y border-gray-100">
                                <div>
                                    <div class="text-xl font-bold mb-1" x-text="data.groom.name"></div>
                                    <div class="text-xs text-gray-400" x-text="data.groom.rank"></div>
                                </div>
                                <div class="text-pink-300 text-2xl">&</div>
                                <div>
                                    <div class="text-xl font-bold mb-1" x-text="data.bride.name"></div>
                                    <div class="text-xs text-gray-400" x-text="data.bride.rank"></div>
                                </div>
                            </div>

                            <div class="space-y-2 text-sm text-gray-500">
                                <div><span x-text="data.groom.parents.father"></span> ¬∑ <span
                                        x-text="data.groom.parents.mother"></span> <span x-text="t('of')">Ïùò</span> <span
                                        x-text="data.groom.rank"></span> <strong class="text-gray-800"
                                        x-text="data.groom.name"></strong></div>
                                <div><span x-text="data.bride.parents.father"></span> ¬∑ <span
                                        x-text="data.bride.parents.mother"></span> <span x-text="t('of')">Ïùò</span> <span
                                        x-text="data.bride.rank"></span> <strong class="text-gray-800"
                                        x-text="data.bride.name"></strong></div>
                            </div>
                        </div>
                    </template>

                    <!-- 2. Calendar -->
                    <template x-if="section.id === 'calendar'">
                        <div class="text-center">
                            <h3 class="text-lg mb-6" x-text="getCalTitle()"></h3>
                            <div class="cal-grid mb-8">
                                <div class="text-red-400 text-xs py-2">SUN</div>
                                <div class="text-gray-400 text-xs py-2">MON</div>
                                <div class="text-gray-400 text-xs py-2">TUE</div>
                                <div class="text-gray-400 text-xs py-2">WED</div>
                                <div class="text-gray-400 text-xs py-2">THU</div>
                                <div class="text-gray-400 text-xs py-2">FRI</div>
                                <div class="text-blue-400 text-xs py-2">SAT</div>
                                <!-- Days render logic handled in script for brevity -->
                                <template x-for="d in calDays">
                                    <div class="cal-cell" :class="getDayClass(d)">
                                        <div :class="isWeddingDay(d.day) ? 'cal-wedding' : ''"
                                            x-text="d.day > 0 ? d.day : ''"></div>
                                    </div>
                                </template>
                            </div>
                            <div class="text-2xl font-bold text-pink-400 animate-pulse" x-text="timerText"></div>
                        </div>
                    </template>

                    <!-- 3. YouTube -->
                    <template x-if="section.id === 'youtube' && data.media.youtube">
                        <div class="aspect-video rounded-lg overflow-hidden shadow-lg">
                            <iframe class="w-full h-full" :src="`https://www.youtube.com/embed/${data.media.youtube}`"
                                frameborder="0" allowfullscreen></iframe>
                        </div>
                    </template>

                    <!-- 4. Gallery -->
                    <template x-if="section.id === 'gallery'">
                        <div class="grid grid-cols-3 gap-2">
                            <template x-for="(img, idx) in data.images.gallery" :key="idx">
                                <div @click="openGallery(img)"
                                    class="aspect-square bg-gray-100 bg-cover bg-center cursor-pointer hover:opacity-80 transition"
                                    :style="`background-image: url(${img})`"></div>
                            </template>
                        </div>
                    </template>

                    <!-- 5. Location -->
                    <template x-if="section.id === 'location'">
                        <div class="space-y-6">
                            <div class="text-center">
                                <h3 class="font-bold text-lg" x-text="data.config.venue.name"></h3>
                                <p class="text-sm text-gray-500 mt-1" x-text="data.config.venue.address"></p>
                                <p class="text-sm text-gray-400 mt-1" x-text="data.config.venue.phone"></p>
                            </div>
                            <div id="map" class="w-full h-64 bg-gray-100 rounded"></div>
                            <div class="flex justify-center gap-4 text-xs">
                                <a :href="data.config.venue.mapLinks.naver" target="_blank"
                                    class="px-4 py-2 border rounded hover:bg-gray-50">Naver Map</a>
                                <a :href="data.config.venue.mapLinks.kakao" target="_blank"
                                    class="px-4 py-2 border rounded hover:bg-gray-50">Kakao Map</a>
                                <a :href="data.config.venue.mapLinks.tmap" target="_blank"
                                    class="px-4 py-2 border rounded hover:bg-gray-50">T-Map</a>
                            </div>
                            <div class="bg-gray-50 p-4 rounded text-xs text-gray-600 whitespace-pre-line"
                                x-text="data.config.venue.guideText"></div>
                        </div>
                    </template>

                    <!-- 6. RSVP -->
                    <template x-if="section.id === 'rsvp'">
                        <div class="space-y-4">
                            <div class="bg-pink-50 p-6 rounded text-center space-y-4">
                                <div class="text-pink-400">üíç</div>
                                <p class="text-sm">Ï∞∏ÏÑùÌï¥Ï£ºÏãúÎäî Î∂ÑÎì§Ïùò Í∑ÄÌïú Î∞úÍ±∏Ïùå<br>ÎØ∏Î¶¨ Í∞êÏÇ¨ÎìúÎ¶ΩÎãàÎã§.</p>
                                <button @click="showRsvpModal = true"
                                    class="bg-pink-400 text-white px-8 py-3 rounded-full hover:bg-pink-500 transition shadow">Ï∞∏ÏÑù
                                    ÏùòÏÇ¨ Ï†ÑÎã¨ÌïòÍ∏∞</button>
                            </div>
                        </div>
                    </template>

                    <!-- 7. Guestbook -->
                    <template x-if="section.id === 'guestbook'">
                        <div class="space-y-4">
                            <template x-for="msg in data.guestbook.slice(0, 3)">
                                <div class="bg-gray-50 p-4 rounded text-sm group">
                                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                                        <span x-text="msg.name" class="font-bold text-gray-600"></span>
                                        <span x-text="msg.date"></span>
                                    </div>
                                    <div x-text="msg.content"></div>
                                </div>
                            </template>
                            <button @click="showGbModal = true"
                                class="w-full py-3 border border-dashed text-gray-400 hover:text-pink-400 hover:border-pink-300 transition">+
                                Ï∂ïÌïò Î©îÏãúÏßÄ ÎÇ®Í∏∞Í∏∞</button>
                        </div>
                    </template>

                </div>
            </div>
        </section>
    </template>

    <footer class="py-12 text-center text-[10px] text-gray-300">
        Copyright(c) Joe All Right Reserved
    </footer>

    <!-- RSVP Modal -->
    <div x-show="showRsvpModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-lg p-6 w-full max-w-sm space-y-4 shadow-2xl" @click.away="showRsvpModal=false">
            <h3 class="text-center font-bold text-lg">Ï∞∏ÏÑù Ïó¨Î∂Ä Ï†ÑÎã¨</h3>
            <div class="space-y-2">
                <input x-model="rsvpForm.name" placeholder="ÏÑ±Ìï®" class="w-full border p-3 text-sm rounded">
                <input x-model="rsvpForm.phone" placeholder="Ïó∞ÎùΩÏ≤ò (-ÏóÜÏù¥ ÏûÖÎ†•)" class="w-full border p-3 text-sm rounded">
                <div class="flex gap-2">
                    <button @click="rsvpForm.attend = true" class="flex-1 py-3 border rounded text-sm"
                        :class="rsvpForm.attend?'bg-pink-400 text-white border-pink-400':''">Ï∞∏ÏÑù</button>
                    <button @click="rsvpForm.attend = false" class="flex-1 py-3 border rounded text-sm"
                        :class="!rsvpForm.attend?'bg-gray-600 text-white border-gray-600':''">Î∂àÏ∞∏</button>
                </div>
                <div class="flex gap-2" x-show="rsvpForm.attend">
                    <select x-model="rsvpForm.meal" class="flex-1 border p-3 rounded text-sm">
                        <option :value="true">ÏãùÏÇ¨ ÏòàÏ†ï</option>
                        <option :value="false">ÏãùÏÇ¨ ÏïàÌï®</option>
                    </select>
                    <select x-model="rsvpForm.plusOnes" class="w-20 border p-3 rounded text-sm">
                        <option value="1">1Î™Ö</option>
                        <option value="2">2Î™Ö</option>
                        <option value="3">3Î™Ö</option>
                    </select>
                </div>
            </div>
            <button @click="submitRsvp" class="w-full bg-black text-white py-4 rounded font-bold">Ï†ÑÎã¨ÌïòÍ∏∞</button>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div x-show="showGalModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black" x-cloak
        @click="showGalModal=false">
        <img :src="activeImg" class="max-w-full max-h-screen object-contain">
    </div>

    <script>
        function app() {
            return {
                lang: 'ko',
                data: {},
                sortedSections: [],
                calDays: [],
                timerText: 'D-Day',
                bgmPlaying: false,
                showRsvpModal: false,
                showGalModal: false, showGbModal: false,
                activeImg: '',
                rsvpForm: { name: '', phone: '', attend: true, meal: true, plusOnes: 1 },
                gbForm: { name: '', content: '' },
                dict: {
                    ko: { names: 'Ï¥àÎåÄÌï©ÎãàÎã§', calendar: 'ÏòàÏãùÏùº', gallery: 'Í∞§Îü¨Î¶¨', location: 'Ïò§ÏãúÎäî Í∏∏', guestbook: 'Î∞©Î™ÖÎ°ù', share: 'Í≥µÏú†', rsvp: 'Ï∞∏ÏÑùÏùòÏÇ¨', of: 'Ïùò' },
                    en: { names: 'Our Wedding', calendar: 'Calendar', gallery: 'Gallery', location: 'Location', guestbook: 'Guestbook', share: 'Share', rsvp: 'RSVP', of: '\'s' }
                },

                async init() {
                    // 1. Detect Lang
                    try {
                        const ipRes = await fetch('https://ipapi.co/json/');
                        const ipData = await ipRes.json();
                        const country = ipData.country_code;
                        if (country === 'US' || country === 'GB') this.lang = 'en';
                        else if (country === 'JP') this.lang = 'jp';
                        else if (country === 'CN') this.lang = 'cn';
                        else this.lang = 'ko'; // Default
                    } catch (e) { console.log('IP Detect Failed', e); }

                    // 2. Fetch Data
                    try {
                        const res = await fetch('data.json');
                        if (res.ok) {
                            this.data = await res.json();
                        } else throw new Error();
                    } catch (e) {
                        // Fallback (for first deploy)
                        const saved = localStorage.getItem('wedding_v2_data');
                        if (saved) this.data = JSON.parse(saved);
                    }

                    if (this.data.sections) {
                        this.sortedSections = this.data.sections.sort((a, b) => a.order - b.order);
                    }

                    this.initCalendar();
                    this.initTimer();
                    this.initMap();
                    this.initPetals();
                    this.initReveal();
                },

                t(key) {
                    if (this.dict[this.lang] && this.dict[this.lang][key]) return this.dict[this.lang][key];
                    if (this.data.sections) {
                        const s = this.data.sections.find(x => x.id === key);
                        if (s) return s.title;
                    }
                    return key;
                },

                changeLang() { /* Trigger re-render by reactive lang */ },

                toggleFold(section) {
                    section.isFolded = !section.isFolded;
                },

                // Logic helpers...
                initCalendar() {
                    if (!this.data.weddingDate) return;
                    const d = new Date(this.data.weddingDate);
                    const y = d.getFullYear(), m = d.getMonth();
                    const firstDay = new Date(y, m, 1).getDay();
                    const lastDate = new Date(y, m + 1, 0).getDate();

                    let days = [];
                    // Pad empty days
                    for (let i = 0; i < firstDay; i++) days.push({ day: 0 });
                    for (let i = 1; i <= lastDate; i++) days.push({ day: i });
                    this.calDays = days;
                },

                getDayClass(d) {
                    if (d.day === 0) return '';
                    // Simple logic for Sat/Sun colors would typically use Date object
                    return '';
                },

                isWeddingDay(d) {
                    if (!this.data.weddingDate) return false;
                    const wed = new Date(this.data.weddingDate);
                    return d === wed.getDate();
                },

                getCalTitle() {
                    if (!this.data.weddingDate) return '';
                    const d = new Date(this.data.weddingDate);
                    return `${d.getFullYear()}. ${d.getMonth() + 1}`;
                },

                initTimer() {
                    setInterval(() => {
                        if (!this.data.weddingDate) return;
                        const target = new Date(this.data.weddingDate);
                        const now = new Date();
                        const diff = target - now;
                        const abs = Math.abs(diff);
                        const days = Math.floor(abs / (1000 * 60 * 60 * 24));
                        this.timerText = (diff > 0 ? 'D-' : 'D+') + days;
                    }, 1000);
                },

                initMap() {
                    const checkKakao = setInterval(() => {
                        if (typeof kakao !== 'undefined' && kakao.maps) {
                            clearInterval(checkKakao);
                            kakao.maps.load(() => {
                                const container = document.getElementById('map');
                                if (!container) return;
                                const geocoder = new kakao.maps.services.Geocoder();
                                geocoder.addressSearch(this.data.config.venue.address || 'ÏÑúÏö∏', (result, status) => {
                                    if (status === kakao.maps.services.Status.OK) {
                                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                        const map = new kakao.maps.Map(container, { center: coords, level: 3 });
                                        new kakao.maps.Marker({ map: map, position: coords });
                                    }
                                });
                            });
                        }
                    }, 500);
                },

                initPetals() {
                    // Simple canvas particle system
                    if (this.data.theme && this.data.theme.effect === 'petals') {
                        // Implement petal logic
                    }
                },

                initReveal() {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) entry.target.classList.add('active');
                        });
                    });
                    setTimeout(() => document.querySelectorAll('.reveal').forEach(el => observer.observe(el)), 500);
                },

                submitRsvp() {
                    // Add logic to push to data.rsvp
                    alert('RSVP Saved Locally! (In a real app, this sends to server)');
                    this.showRsvpModal = false;
                }
            }
        }
    </script>
</body>

</html>