<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Invitation</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Great+Vibes&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Noto+Sans+KR:wght@300;400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=dacffa882aa3284870d06afa02bd5947&libraries=services"></script>

    <style>
        :root {
            --accent: #f2aebc;
            --text: #333;
        }

        body {
            font-family: 'Gowun Batang', serif;
            color: var(--text);
            overflow-x: hidden;
            background: #fffcfc;
        }

        .eng-font {
            font-family: 'Great Vibes', cursive;
        }

        .lux-font {
            font-family: 'Nanum Myeongjo', serif;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Intro */
        #intro-layer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            transition: opacity 1s;
        }

        .scroll-icon {
            border: 2px solid white;
            width: 30px;
            height: 50px;
            border-radius: 15px;
            position: relative;
        }

        .scroll-icon::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 8px;
            background: white;
            border-radius: 2px;
            animation: scrollDown 1.5s infinite;
        }

        @keyframes scrollDown {
            0% {
                top: 8px;
                opacity: 1;
            }

            100% {
                top: 25px;
                opacity: 0;
            }
        }

        /* Effects */
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 50;
            width: 100vw;
            height: 100vh;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .max-w-lg {
                width: 100%;
                border-radius: 0;
            }

            .section-wrap {
                box-shadow: none;
                border-bottom: 1px solid #f9f9f9;
            }
        }

        /* Layout */
        .section-wrap {
            opacity: 0;
            transform: translateY(50px);
            transition: 1s cubic-bezier(0.2, 1, 0.3, 1);
            margin-bottom: 2px;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        }

        .section-wrap.active {
            opacity: 1;
            transform: translateY(0);
        }

        .content-body {
            transition: max-height 0.8s ease-in-out;
            overflow: hidden;
            max-height: 3000px;
        }

        .content-body.folded {
            max-height: 0;
        }

        /* Gallery Grid */
        .gal-grid-item {
            aspect-ratio: 1;
            background-size: cover;
            background-position: center;
            border: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .gal-main {
            width: 100%;
            aspect-ratio: 3/4;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s;
            position: relative;
        }

        .gal-main::after {
            content: '';
            position: absolute;
            inset: 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }
    </style>
</head>

<body x-data="app()" x-init="init()" class="relative" @mousemove="handleMouseMove($event)"
    @mousedown="handleMouseDown($event)" @touchstart="handleTouchStart($event)">

    <!-- Intro Layer -->
    <div id="intro-layer" x-show="showIntro" @click="closeIntro" @wheel.prevent="closeIntro"
        @touchmove.prevent="closeIntro">
        <div class="text-3xl eng-font mb-4 animate-pulse">Our Wedding</div>
        <div class="scroll-icon mb-4"></div>
        <div class="text-xs tracking-widest opacity-80">SCROLL DOWN</div>
    </div>

    <!-- Floating Nav -->
    <div class="fixed top-4 left-4 z-[90] flex flex-col gap-2 transition-all duration-300"
        :class="showIntro?'opacity-0':'opacity-100'">
        <!-- BGM -->
        <button x-show="data.media && data.media.bgm && data.media.bgm.length > 0" @click="toggleBgm"
            class="w-10 h-10 rounded-full bg-white/60 backdrop-blur shadow border border-gray-100 flex items-center justify-center animate-[spin_4s_linear_infinite]"
            :style="bgmPlaying ? '' : 'animation: none'">
            üíø
        </button>
    </div>
    <div class="fixed top-4 right-4 z-[90] flex gap-2 transition-all duration-300"
        :class="showIntro?'opacity-0':'opacity-100'">
        <!-- Lang -->
        <select x-model="lang" class="bg-white/80 backdrop-blur border rounded-full px-3 py-1 text-xs outline-none">
            <option value="ko">KR</option>
            <option value="en">EN</option>
            <option value="jp">JP</option>
            <option value="cn">CN</option>
        </select>
        <!-- TTS -->
        <button @click="speakAll"
            class="w-8 h-8 rounded-full bg-pink-100/80 backdrop-blur flex items-center justify-center text-sm shadow">
            üëÑ
        </button>
    </div>

    <!-- Effect Canvas -->
    <canvas id="effect"></canvas>

    <!-- Main Content -->
    <div class="max-w-lg mx-auto pb-32">

        <!-- Hero Section (Fixed ID: names) handled dynamically via sort -->
        <template x-for="section in sortedSections" :key="section.id">
            <template x-if="section.isVisible">
                <div class="section-wrap relative" :id="section.id" :class="section.id === 'names' ? 'pt-0' : ''">

                    <!-- Toggle Header (Except Names) -->
                    <div x-show="section.id !== 'names'" @click="section.isFolded = !section.isFolded"
                        class="p-6 cursor-pointer flex justify-between items-center bg-white z-10 relative">
                        <h2 class="text-lg lux-font font-bold text-gray-700 tracking-wide"
                            x-text="t(section.id) === section.id ? section.title : t(section.id)"></h2>
                        <span class="text-gray-300 text-xs" x-text="section.isFolded ? '‚ñº' : '‚ñ≤'"></span>
                    </div>

                    <!-- Body -->
                    <div class="content-body" :class="section.isFolded ? 'folded' : ''">

                        <!-- 1. Names/Hero -->
                        <template x-if="section.id === 'names'">
                            <div class="text-center pb-12 bg-white">
                                <div class="relative w-full aspect-[3/4] bg-cover bg-center mb-12"
                                    :style="`background-image: url(${data.images.main})`">
                                    <div class="absolute inset-0 flex flex-col items-center p-12 bg-black/10">
                                        <div class="eng-font text-white text-4xl mt-12 drop-shadow-md"
                                            x-text="data.text.mainOverlay"></div>
                                    </div>
                                </div>

                                <div class="whitespace-pre-line leading-8 text-sm text-gray-600 mb-8 lux-font"
                                    x-text="data.text.mainMessage"></div>

                                <div class="py-8 border-y border-gray-50 mx-8 flex justify-center items-center gap-8">
                                    <div>
                                        <div class="text-xl font-bold mb-1" x-text="data.groom.name"></div>
                                        <div class="text-[10px] text-gray-400 tracking-widest">GROOM</div>
                                    </div>
                                    <div class="text-pink-300 text-2xl eng-font">&</div>
                                    <div>
                                        <div class="text-xl font-bold mb-1" x-text="data.bride.name"></div>
                                        <div class="text-[10px] text-gray-400 tracking-widest">BRIDE</div>
                                    </div>
                                </div>

                                <!-- Parents -->
                                <div class="mt-8 space-y-2 text-sm text-gray-500">
                                    <div>
                                        <span x-text="data.groom.parents.father"></span>¬∑<span
                                            x-text="data.groom.parents.mother"></span> <span x-text="t('of')">Ïùò</span>
                                        <span x-text="data.groom.rank"></span> <b><span
                                                x-text="data.groom.name"></span></b>
                                    </div>
                                    <div>
                                        <span x-text="data.bride.parents.father"></span>¬∑<span
                                            x-text="data.bride.parents.mother"></span> <span x-text="t('of')">Ïùò</span>
                                        <span x-text="data.bride.rank"></span> <b><span
                                                x-text="data.bride.name"></span></b>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- 2. Calendar -->
                        <template x-if="section.id === 'calendar'">
                            <div class="px-8 pb-10 text-center">
                                <div class="text-xl mb-6 font-serif" x-text="calTitle"></div>
                                <div class="grid grid-cols-7 gap-1 text-sm mb-8">
                                    <div class="text-red-400 py-2">S</div>
                                    <div class="text-gray-400 py-2">M</div>
                                    <div class="text-gray-400 py-2">T</div>
                                    <div class="text-gray-400 py-2">W</div>
                                    <div class="text-gray-400 py-2">T</div>
                                    <div class="text-gray-400 py-2">F</div>
                                    <div class="text-blue-400 py-2">S</div>
                                    <template x-for="d in calDays">
                                        <div class="aspect-square flex items-center justify-center rounded-full"
                                            :class="{'text-red-400': d.w===0, 'text-blue-400': d.w===6, 'bg-pink-300 text-white shadow-lg': d.isWed}">
                                            <span x-text="d.day || ''"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="text-2xl lux-font font-bold text-pink-400" x-text="dDay"></div>
                            </div>
                        </template>

                        <!-- 3. Video -->
                        <template x-if="section.id === 'youtube' && data.media.youtube">
                            <div class="px-8 pb-10">
                                <div class="relative w-full aspect-video bg-black rounded shadow-lg overflow-hidden group cursor-pointer"
                                    @click="showVideo=true">
                                    <img :src="`https://img.youtube.com/vi/${data.media.youtube}/maxresdefault.jpg`"
                                        class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div
                                            class="w-12 h-12 bg-white/80 rounded-full flex items-center justify-center text-xl pl-1">
                                            ‚ñ∂</div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- 4. Gallery -->
                        <template x-if="section.id === 'gallery'">
                            <div class="px-4 pb-10">
                                <div class="gal-main mb-2 rounded shadow-xl"
                                    :style="`background-image: url(${data.images.gallery[galIdx] || ''})`"
                                    @click="openLightbox(data.images.gallery[galIdx])">
                                </div>
                                <div class="grid grid-cols-5 gap-1">
                                    <template x-for="(img, idx) in data.images.gallery.slice(0,30)" :key="idx">
                                        <div class="gal-grid-item" :style="`background-image: url(${img})`"
                                            :class="galIdx===idx ? 'ring-2 ring-pink-300 z-10' : ''"
                                            @click="galIdx = idx"></div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- 5. Contact -->
                        <template x-if="section.id === 'phone'">
                            <div class="px-8 pb-10 space-y-6">
                                <div class="grid grid-cols-2 gap-8 text-center text-sm">
                                    <div class="space-y-3">
                                        <div class="font-bold text-blue-900 border-b pb-2 mb-2">GROOM</div>
                                        <template x-for="p in getPhones('groom')">
                                            <div class="flex justify-between items-center text-xs text-gray-500">
                                                <span x-text="p.label"></span>
                                                <a :href="`tel:${p.phone}`">üìû</a>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="font-bold text-pink-900 border-b pb-2 mb-2">BRIDE</div>
                                        <template x-for="p in getPhones('bride')">
                                            <div class="flex justify-between items-center text-xs text-gray-500">
                                                <span x-text="p.label"></span>
                                                <a :href="`tel:${p.phone}`">üìû</a>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- 6. Accounts -->
                        <template x-if="section.id === 'accounts'">
                            <div class="px-8 pb-10 space-y-4">
                                <div class="text-center text-xs text-gray-400 mb-6">ÎßàÏùåÏùÑ Ï†ÑÌïòÏã§ Í≥≥</div>
                                <!-- Accordions for Groom/Bride sides -->
                                <template x-for="side in ['groom', 'bride']">
                                    <div class="border rounded px-4 py-3 bg-gray-50">
                                        <div class="font-bold text-sm mb-2 capitalize" x-text="side"></div>
                                        <template x-for="acc in getAccounts(side)">
                                            <div
                                                class="flex justify-between items-center text-xs py-2 border-t border-gray-100">
                                                <div>
                                                    <div x-text="acc.label"></div>
                                                    <div class="text-gray-400" x-text="`${acc.bank} ${acc.account}`">
                                                    </div>
                                                </div>
                                                <button @click="copy(acc.bank + ' ' + acc.account)"
                                                    class="bg-white border px-2 py-1 rounded">Copy</button>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- 7. Location -->
                        <template x-if="section.id === 'location'">
                            <div class="px-6 pb-10">
                                <div class="text-center mb-6">
                                    <div class="font-bold text-lg" x-text="data.config.venue.name"></div>
                                    <div class="text-sm text-gray-500 mt-1" x-text="data.config.venue.address"></div>
                                </div>
                                <div id="map" class="w-full h-64 bg-gray-100 rounded mb-4"></div>
                                <div class="whitespace-pre-line text-xs text-gray-500 leading-6 bg-gray-50 p-4 rounded"
                                    x-text="data.config.venue.guideText"></div>
                            </div>
                        </template>

                    </div>
                </div>
            </template>
        </template>
    </div>

    <!-- Modals -->
    <div x-show="showVideo" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" x-cloak
        @click="showVideo=false">
        <div class="w-full max-w-2xl aspect-video bg-black" @click.stop>
            <iframe class="w-full h-full"
                :src="showVideo ? `https://www.youtube.com/embed/${data.media.youtube}?autoplay=1` : ''"
                allow="autoplay" frameborder="0"></iframe>
        </div>
    </div>

    <div x-show="lightbox" class="fixed inset-0 z-[100] bg-black flex items-center justify-center" x-cloak
        @click="lightbox=null">
        <img :src="lightbox" class="max-w-full max-h-screen object-contain">
    </div>

    <!-- Scripts -->
    <script>
        function app() {
            return {
                lang: 'ko', showIntro: true, showVideo: false, lightbox: null,
                data: {}, sortedSections: [],
                calDays: [], calTitle: '', dDay: '',
                bgmPlaying: false, audio: null,
                galIdx: 0,

                dict: {
                    ko: { names: 'Ï¥àÎåÄÌï©ÎãàÎã§', calendar: 'ÏÜåÏ§ëÌïú ÎÇ†', of: 'Ïùò' },
                    en: { names: 'Invite You', calendar: 'The Date', of: '\'s' }
                },

                async init() {
                    // Check Session for Intro
                    if (sessionStorage.getItem('visited')) this.showIntro = false;

                    // Fetch Data
                    try {
                        this.data = await (await fetch('data.json')).json();
                        this.processSections();
                        this.initCal();
                        this.initEffects();
                        this.initMap();

                        // Gallery Loop
                        setInterval(() => {
                            if (this.data.images.gallery.length) {
                                this.galIdx = (this.galIdx + 1) % this.data.images.gallery.length;
                            }
                        }, 5000);

                        // Observer
                        setTimeout(() => this.initObserver(), 500);

                    } catch (e) { }
                },

                closeIntro() {
                    this.showIntro = false;
                    sessionStorage.setItem('visited', 'true');
                    this.initObserver(); // Re-trigger
                },

                toggleBgm() {
                    if (!this.data.media.bgm.length) return;
                    if (!this.audio) {
                        this.audio = new Audio(this.data.media.bgm[0]);
                        this.audio.loop = true; // Simple loop 1st track for now. Logic for playlist can be added.
                    }
                    if (this.bgmPlaying) this.audio.pause();
                    else this.audio.play();
                    this.bgmPlaying = !this.bgmPlaying;
                },

                t(key) { return (this.dict[this.lang] && this.dict[this.lang][key]) || key; },

                processSections() {
                    if (this.data.sections) this.sortedSections = this.data.sections.sort((a, b) => a.order - b.order);
                },

                initCal() {
                    if (!this.data.config.weddingDate) return;
                    const d = new Date(this.data.config.weddingDate);
                    this.calTitle = `${d.getFullYear()}. ${d.getMonth() + 1}`;

                    // Logic to fill calDays with { day: 1, w: 0..6, isWed: bool }
                    const y = d.getFullYear(), m = d.getMonth();
                    const firstDay = new Date(y, m, 1).getDay();
                    const lastDate = new Date(y, m + 1, 0).getDate();

                    let arr = [];
                    for (let i = 0; i < firstDay; i++) arr.push({ day: 0 });
                    for (let i = 1; i <= lastDate; i++) {
                        const cur = new Date(y, m, i);
                        arr.push({ day: i, w: cur.getDay(), isWed: i === d.getDate() });
                    }
                    this.calDays = arr;

                    // D-Day
                    const now = new Date();
                    const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
                    this.dDay = diff > 0 ? `D-${diff}` : `D+${Math.abs(diff)}`;
                },

                initEffects() {
                    const canvas = document.getElementById('effect');
                    const ctx = canvas.getContext('2d');

                    const resize = () => {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                    };
                    window.addEventListener('resize', resize);
                    resize();

                    const type = this.data.theme.effect || 'petals';
                    this.particles = [];

                    class Particle {
                        constructor(config = {}) {
                            this.isExplosion = config.isExplosion || false;
                            this.x = config.x !== undefined ? config.x : Math.random() * canvas.width;
                            this.y = config.y !== undefined ? config.y : -20;
                            this.size = Math.random() * (this.isExplosion ? 4 : 6) + 2;
                            this.speedX = this.isExplosion ? (Math.random() - 0.5) * 12 : (Math.random() - 0.5) * 0.5;
                            this.speedY = this.isExplosion ? (Math.random() - 0.5) * 12 : Math.random() * 2 + 1;
                            this.angle = Math.random() * 360;
                            this.spin = Math.random() * 4 - 2;
                            this.life = 1.0;
                            this.opacity = 1.0;
                        }
                        update() {
                            this.x += this.speedX;
                            this.y += this.speedY;
                            this.angle += this.spin;
                            if (this.isExplosion) {
                                this.life -= 0.02;
                                this.opacity = Math.max(0, this.life);
                            } else if (this.y > canvas.height + 20) {
                                this.y = -20;
                                this.x = Math.random() * canvas.width;
                            }
                        }
                        draw() {
                            ctx.save();
                            ctx.translate(this.x, this.y);
                            ctx.rotate(this.angle * Math.PI / 180);
                            ctx.globalAlpha = this.opacity;
                            ctx.fillStyle = this.getColor();
                            ctx.beginPath();
                            if (type === 'snow') ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                            else ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                            ctx.fill();
                            ctx.restore();
                        }
                        getColor() {
                            if (this.isExplosion) return '#fff700';
                            if (type === 'snow') return '#fff';
                            if (type === 'leaves') return '#ff9a00';
                            return '#f2aebc';
                        }
                    }

                    class Trail {
                        constructor(x, y) {
                            this.x = x; this.y = y;
                            this.size = Math.random() * 3 + 2;
                            this.life = 1.0;
                        }
                        update() { this.life -= 0.05; }
                        draw() {
                            ctx.save();
                            ctx.globalAlpha = this.life * 0.4;
                            ctx.fillStyle = "#fff";
                            ctx.beginPath();
                            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.restore();
                        }
                    }

                    for (let i = 0; i < 40; i++) this.particles.push(new Particle());
                    this.trails = [];

                    const loop = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        this.particles = this.particles.filter(p => !p.isExplosion || p.life > 0);
                        this.particles.forEach(p => { p.update(); p.draw(); });
                        this.trails = this.trails.filter(t => t.life > 0);
                        this.trails.forEach(t => { t.update(); t.draw(); });
                        requestAnimationFrame(loop);
                    };
                    loop();

                    this._createTrail = (x, y) => this.trails.push(new Trail(x, y));
                    this._createExplosion = (x, y) => {
                        for (let i = 0; i < 20; i++) this.particles.push(new Particle({ isExplosion: true, x, y }));
                    };
                },

                handleMouseMove(e) { if (this._createTrail) this._createTrail(e.clientX, e.clientY); },
                handleMouseDown(e) { if (this._createExplosion) this._createExplosion(e.clientX, e.clientY); },
                handleTouchStart(e) { if (this._createExplosion) this._createExplosion(e.touches[0].clientX, e.touches[0].clientY); },

                initMap() {
                    // Kakao Map
                    const check = setInterval(() => {
                        if (typeof kakao !== 'undefined' && kakao.maps) {
                            clearInterval(check);
                            kakao.maps.load(() => {
                                const container = document.getElementById('map');
                                if (!container) return;
                                const geocoder = new kakao.maps.services.Geocoder();
                                geocoder.addressSearch(this.data.config.venue.address || 'Seoul', (res, status) => {
                                    if (status === kakao.maps.services.Status.OK) {
                                        const coords = new kakao.maps.LatLng(res[0].y, res[0].x);
                                        const map = new kakao.maps.Map(container, { center: coords, level: 3 });
                                        new kakao.maps.Marker({ map: map, position: coords });
                                    }
                                });
                            });
                        }
                    }, 500);
                },

                initObserver() {
                    const obs = new IntersectionObserver(entries => {
                        entries.forEach(e => {
                            if (e.isIntersecting) e.target.classList.add('active');
                        });
                    }, { threshold: 0.1 });
                    document.querySelectorAll('.section-wrap').forEach(el => obs.observe(el));
                },

                openLightbox(img) { this.lightbox = img; },

                getPhones(side) {
                    const p = this.data[side];
                    const pp = p.parents;
                    let list = [{ label: p.name, phone: p.phone }];
                    if (pp.father) list.push({ label: pp.father, phone: pp.fPhone });
                    if (pp.mother) list.push({ label: pp.mother, phone: pp.mPhone });
                    return list;
                },

                getAccounts(side) {
                    const p = this.data[side];
                    const pp = p.parents;
                    let list = [{ label: p.name, bank: p.bank, account: p.account }];
                    if (pp.father) list.push({ label: pp.father, bank: pp.fBank, account: pp.fAccount });
                    if (pp.mother) list.push({ label: pp.mother, bank: pp.mBank, account: pp.mAccount });
                    return list;
                },

                copy(txt) {
                    navigator.clipboard.writeText(txt).then(() => alert('Copied!'));
                },

                speakAll() {
                    if ('speechSynthesis' in window) {
                        const txt = document.body.innerText; // Simple grab
                        const ut = new SpeechSynthesisUtterance(txt);
                        ut.lang = this.lang;
                        window.speechSynthesis.speak(ut);
                    } else alert('TTS not supported');
                }
            }
        }
    </script>
</body>

</html>